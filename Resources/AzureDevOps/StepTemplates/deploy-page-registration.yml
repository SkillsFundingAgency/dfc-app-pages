parameters:
  azureSubscription: ''
  DfCDevopsPath: ''
  PageRegistrationPath: ''
  PageRegistrationFile: ''
  PathRegistrationApiUrl: ''
  RegionRegistrationApiUrl: ''
  ApimCompositeKey: ''

steps:
- checkout: dfc-devops
  path: 's/dfc-devops/'

- task: esfadevops.Tokenization.custom-build-task.Tokenization@0
  displayName: 'Tokenization: Transform file ${{ parameters.PageRegistrationFile }}'
  inputs:
    SourcePath: '${{ parameters.PageRegistrationPath }}'
    TargetFileNames: '${{ parameters.PageRegistrationFile }}'

- task: PowerShell@2
  displayName: 'Register application'
  inputs:
    azureSubscription: '${{ parameters.AzureSubscription }}'
    targetType: filePath
    # filePath: './${{ parameters.DfCDevopsPath }}/PSScripts/Invoke-AddOrUpdateCompositeRegistrations.ps1'
    filePath: './PSScripts/Invoke-AddOrUpdateCompositeRegistrations.ps1'
    arguments: '-PathApiUrl ${{ parameters.PathRegistrationApiUrl }}  -RegionApiUrl ${{ parameters.RegionRegistrationApiUrl }} -RegistrationFile ${{ parameters.PageRegistrationPath }}/${{ parameters.PageRegistrationFile }} -ApiKey ${{ parameters.ApimCompositeKey }} -Verbose'
    # workingDirectory: '${{ parameters.DfCDevopsPath }}/PSScripts'

# - task: AzurePowerShell@4
#   displayName: 'Register application'
#   inputs:
#     azureSubscription: '${{ parameters.AzureSubscription }}'
#     ScriptPath: '${{ parameters.DfCDevopsPath }}/PSScripts/Invoke-AddOrUpdateCompositeRegistrations.ps1'
#     ScriptArguments: '-PathApiUrl ${{ parameters.PathRegistrationApiUrl }}  -RegionApiUrl ${{ parameters.RegionRegistrationApiUrl }} -RegistrationFile ${{ parameters.PageRegistrationPath }}/${{ parameters.PageRegistrationFile }} -ApiKey ${{ parameters.ApimCompositeKey }} -Verbose'
#     azurePowerShellVersion: LatestVersion

- task: DeleteFiles@1
  displayName: 'Remove tokenized page registration file'
  inputs:
    SourceFolder: '${{ parameters.PageRegistrationPath }}'
    Contents: '${{ parameters.PageRegistrationFile }}'
  condition: always()